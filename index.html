<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate 2D RPG</title>
<style>
body { margin:0; background:#111; font-family:sans-serif; color:white; display:flex; flex-direction:column; align-items:center; }
canvas { border:3px solid #222; background:#333; margin-top:10px; }
#hud { margin-top:10px; }
#inventory, #quests { margin-top:5px; }
</style>
</head>
<body>
<h1>Ultimate 2D RPG</h1>
<canvas id="game" width="640" height="480"></canvas>
<div id="hud"></div>
<div id="inventory"></div>
<div id="quests"></div>

<script>
// ===== CANVAS SETUP =====
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const hud = document.getElementById("hud");
const inventoryDiv = document.getElementById("inventory");
const questsDiv = document.getElementById("quests");

const tileSize = 32;

// ===== GAME DATA =====

// Map tiles (0=floor,1=wall,2=npc,3=item,4=portal)
let maps = [
  [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,4,1],
    [1,0,1,1,0,1,1,1,0,1,1,1,0,0,1,1,1,0,0,1],
    [1,0,0,0,0,0,0,1,0,0,0,1,2,0,0,0,0,0,0,1],
    [1,0,1,1,1,1,0,1,0,1,0,1,1,0,1,1,0,1,0,1],
    [1,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,1],
    [1,1,1,1,0,1,1,1,0,1,1,1,1,0,0,1,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,1,1,1,1,1,1,1,1,0,1,1,0,0,1,1,1,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ]
];

let currentMap = 0;
let map = maps[currentMap];

// ===== PLAYER PARTY =====
let players = [
  {name:"Luffy", x:1, y:1, hp:50, mp:20, color:"yellow", inventory:[], xp:0, level:1},
  {name:"Zoro", x:2, y:1, hp:45, mp:15, color:"green", inventory:[], xp:0, level:1},
  {name:"Nami", x:3, y:1, hp:40, mp:25, color:"orange", inventory:[], xp:0, level:1}
];

let currentPlayer = 0;

// ===== ENEMIES =====
let enemies = [
  {x:10,y:5,hp:20,color:"red",xp:20},
  {x:13,y:8,hp:30,color:"purple",xp:30}
];

// ===== ITEMS =====
let items = [
  {x:15,y:1,name:"Potion",effect:(p)=>{p.hp+=20; alert(`${p.name} restored 20 HP!`);}},
  {x:5,y:5,name:"Gold",effect:(p)=>{alert(`${p.name} collected Gold!`);}}
];

// ===== NPCs =====
let npcs = [
  {x:12,y:3,text:"Hey heroes! Collect the Potion and reach the portal to advance!",quest:"Collect Potion"}
];

// ===== PORTALS =====
let portals = [
  {x:18,y:1,targetMap:0,targetX:1,targetY:1}
];

// ===== DRAW FUNCTION =====
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  // Draw map
  for(let y=0;y<map.length;y++){
    for(let x=0;x<map[y].length;x++){
      let tile=map[y][x];
      if(tile===1) ctx.fillStyle="#222";
      else ctx.fillStyle="#666";
      ctx.fillRect(x*tileSize,y*tileSize,tileSize,tileSize);
    }
  }
  
  // Items
  items.forEach(i=>{
    ctx.fillStyle="#ff0";
    ctx.fillRect(i.x*tileSize,i.y*tileSize,tileSize,tileSize);
  });
  
  // NPCs
  npcs.forEach(n=>{
    ctx.fillStyle="#0af";
    ctx.fillRect(n.x*tileSize,n.y*tileSize,tileSize,tileSize);
  });
  
  // Portals
  portals.forEach(p=>{
    ctx.fillStyle="#f0f";
    ctx.fillRect(p.x*tileSize,p.y*tileSize,tileSize,tileSize);
  });
  
  // Enemies
  enemies.forEach(e=>{
    ctx.fillStyle=e.color;
    ctx.fillRect(e.x*tileSize,e.y*tileSize,tileSize,tileSize);
  });
  
  // Players
  players.forEach(p=>{
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x*tileSize,p.y*tileSize,tileSize,tileSize);
  });
  
  updateHUD();
}

// ===== HUD =====
function updateHUD(){
  let p=players[currentPlayer];
  hud.innerHTML=`Current: ${p.name} | HP: ${p.hp} | MP: ${p.mp} | Level: ${p.level} | XP: ${p.xp}`;
  inventoryDiv.innerHTML=`Inventory: ${p.inventory.join(", ")}`;
  questsDiv.innerHTML=`Quests: ${p.quests ? p.quests.join(", ") : ""}`;
}

// ===== PLAYER MOVEMENT =====
document.addEventListener("keydown",e=>{
  let p=players[currentPlayer];
  let nx=p.x;
  let ny=p.y;
  
  if(e.key==="ArrowUp") ny--;
  if(e.key==="ArrowDown") ny++;
  if(e.key==="ArrowLeft") nx--;
  if(e.key==="ArrowRight") nx++;
  if(e.key==="Tab"){ // Switch character
    currentPlayer=(currentPlayer+1)%players.length;
    draw();
    return;
  }
  
  if(map[ny] && map[ny][nx]!==1){
    p.x=nx; p.y=ny;
  }
  
  // Items
  items.forEach((i,index)=>{
    if(p.x===i.x && p.y===i.y){
      p.inventory.push(i.name);
      i.effect(p);
      items.splice(index,1);
    }
  });
  
  // NPCs
  npcs.forEach(n=>{
    if(p.x===n.x && p.y===n.y){
      alert(n.text);
      if(!p.quests) p.quests=[];
      if(!p.quests.includes(n.quest)) p.quests.push(n.quest);
    }
  });
  
  // Enemies
  enemies.forEach((e,index)=>{
    if(p.x===e.x && p.y===e.y){
      e.hp-=10;
      p.hp-=5;
      alert(`Combat! ${p.name} HP:${p.hp} Enemy HP:${e.hp}`);
      if(e.hp<=0){
        alert("Enemy defeated!");
        p.xp+=e.xp;
        enemies.splice(index,1);
        if(p.xp>=p.level*50){p.level++; p.xp=0; alert(`${p.name} leveled up!`);}
      }
      if(p.hp<=0){
        alert(`${p.name} died! Respawning...`);
        p.hp=50; p.x=1; p.y=1;
      }
    }
  });
  
  // Portals
  portals.forEach(portal=>{
    if(p.x===portal.x && p.y===portal.y){
      map=maps[portal.targetMap];
      p.x=portal.targetX;
      p.y=portal.targetY;
      alert(`${p.name} entered a new area!`);
    }
  });
  
  draw();
});

// ===== ENEMY AI =====
function moveEnemies(){
  enemies.forEach(e=>{
    let target=players[0]; // simple AI toward first player
    let dx=target.x-e.x;
    let dy=target.y-e.y;
    if(Math.abs(dx)>Math.abs(dy)) e.x += dx>0?1:-1;
    else e.y += dy>0?1:-1;
    if(map[e.y] && map[e.y][e.x]===1){e.x-=dx>0?1:-1; e.y-=dy>0?1:-1;}
  });
  draw();
}

setInterval(moveEnemies,1000);

// ===== INITIAL DRAW =====
draw();
</script>
</body>
</html>
